import streamlit as st
from utils.state_manager import flatten_session_state
from utils.sheet_io import append_or_update_row
from utils.ui_styles import render_info_box, render_data_protection_box

# ðŸ” Safe float conversion helper
def safe_float(value, default=0.0):
    try:
        return float(value)
    except (ValueError, TypeError):
        return default


def render():
    st.header("7. ðŸ’¡ Servicios PÃºblicos del Banco de Leche Humana (BLH)")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Instrucciones Visuales
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    st.markdown(render_info_box("""
    > â„¹ï¸ **Â¿QuÃ© informaciÃ³n debe registrar?**  
    Por favor indique el **costo mensual promedio** (en pesos COP) de los **servicios pÃºblicos** necesarios para el funcionamiento del Banco de Leche Humana (BLH).  
    Si un servicio no aplica, registre **0**.

    > ðŸ“ **Ejemplo prÃ¡ctico:**  
    - EnergÃ­a elÃ©ctrica: *150,000 COP*  
    - Agua y alcantarillado: *90,000 COP*  
    - TelefonÃ­a e internet: *70,000 COP*

    > ðŸ”‘ **Importancia:**  
    Estos datos permitirÃ¡n estimar los **costos operativos** del BLH y apoyar anÃ¡lisis de sostenibilidad.

    """), unsafe_allow_html=True)

    st.markdown(render_data_protection_box("""
    > ðŸ”’ La informaciÃ³n suministrada serÃ¡ utilizada Ãºnicamente para los fines de este estudio y protegida conforme a la **Ley 1581 de 2012 (Habeas Data)**.
    """), unsafe_allow_html=True)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Variables de Estado
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    prefix = "servicios_publicos__"
    completion_flag = prefix + "completed"
    data_key = prefix + "data"

    stored_data = st.session_state.get(data_key, {})

    servicios = [
        "Suministro de energÃ­a",
        "Suministro de agua y alcantarillado",
        "TelefonÃ­a fija e internet"
    ]

    current_results = {}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Render Inputs por Servicio
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    for servicio in servicios:
        costo = st.number_input(
            f"ðŸ’° {servicio} (Costo mensual en $ COP)",
            min_value=0.0,
            step=1000.0,
            value=safe_float(stored_data.get(servicio, 0.0)),
            key=f"util_{servicio}",
            help=f"Ingrese el costo mensual promedio de {servicio}. Registre 0 si no aplica."
        )
        current_results[servicio] = costo

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ValidaciÃ³n de Completitud para Progreso
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    has_data = any(value > 0 for value in current_results.values())
    st.session_state[completion_flag] = has_data

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # BotÃ³n de Guardado con Feedback
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    if st.button("ðŸ’¾ Guardar secciÃ³n - Servicios PÃºblicos"):
        st.session_state[data_key] = current_results
        st.session_state[completion_flag] = any(value > 0 for value in current_results.values())

        flat_data = flatten_session_state(st.session_state)
        success = append_or_update_row(flat_data)

        if success:
            st.success("âœ… Datos de servicios pÃºblicos guardados exitosamente.")
            if "section_index" in st.session_state and st.session_state.section_index < 9:
                st.session_state.section_index += 1
                st.session_state.navigation_triggered = True
                st.rerun()
        else:
            st.error("âŒ Error al guardar los datos. Por favor verifique la conexiÃ³n e intente nuevamente.")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Expander: VisualizaciÃ³n de Datos Guardados
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    with st.expander("ðŸ” Ver resumen de datos guardados"):
        st.write(st.session_state.get(data_key, current_results))
