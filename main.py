import streamlit as st

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Import Local Modules
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from sections import (
    identification, general_info, processes, donors_recipients,
    infrastructure, supplies, staff, utilities,
    transport, quality, depreciation
)

from utils.state_manager import compute_progress, flatten_session_state
from utils.sheet_io import load_existing_data, append_or_update_row
from utils.ui_styles import render_info_box
from utils.ui_layout import render_header, render_footer
from config import INSTRUCTIVO_URL

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Page Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

st.set_page_config(page_title="Encuesta BLH", layout="wide")

# Header Institucional
render_header()

# IntroducciÃ³n
st.markdown(render_info_box(f"""
Complete cada secciÃ³n. Puede guardar su progreso y continuar mÃ¡s tarde.<br><br>
<strong>Nota:</strong> La informaciÃ³n estÃ¡ protegida por el derecho fundamental de <strong>Habeas Data</strong> (Ley 1581 de 2012). Consulte el <a href='{INSTRUCTIVO_URL}' target='_blank'>Instructivo aquÃ­</a>.
"""), unsafe_allow_html=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Secciones
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

section_definitions = [
    {"label": "1. Datos Generales", "key": "datos_generales__completed", "render": general_info.render},
    {"label": "2. Procesos Estandarizados", "key": "procesos_realizados__completed", "render": processes.render},
    {"label": "3. Donantes y Receptores", "key": "donantes_receptores__completed", "render": donors_recipients.render},
    {"label": "4. Infraestructura y Equipos", "key": "infraestructura_equipos__completed", "render": infrastructure.render},
    {"label": "5. Insumos Mensuales", "key": "insumos_mensuales__completed", "render": supplies.render},
    {"label": "6. Personal Asignado", "key": "personal_exclusivo__completed", "render": staff.render},
    {"label": "7. Servicios PÃºblicos", "key": "servicios_publicos__completed", "render": utilities.render},
    {"label": "8. Transporte y RecolecciÃ³n", "key": "transporte_modalidades__completed", "render": transport.render},
    {"label": "9. Eficiencia y Calidad", "key": "calidad_seguridad__completed", "render": quality.render},
    {"label": "10. DepreciaciÃ³n e Impuestos", "key": "depreciacion__completed", "render": depreciation.render},
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# IdentificaciÃ³n Inicial
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

identification.render()

if "identificacion" not in st.session_state:
    st.warning("âš ï¸ Por favor complete la identificaciÃ³n para continuar.")
    st.stop()

ips_id = st.session_state["identificacion"].get("ips_id", "").strip().lower()
if ips_id and not st.session_state.get("data_loaded", False):
    existing_data = load_existing_data(ips_id)
    if existing_data:
        widget_keys_to_skip = {"ips_id_input", "correo_responsable_input", "nombre_responsable_input"}
        safe_data = {k: v for k, v in existing_data.items() if k not in widget_keys_to_skip and not k.startswith("FormSubmitter:")}
        st.session_state.update(safe_data)
        st.info(f"ğŸ“‚ Datos previos restaurados para IPS: `{ips_id}`.")
    else:
        st.info("ğŸ“ No se encontraron datos previos para esta IPS.")
    st.session_state["data_loaded"] = True
    st.rerun()

if "section_index" not in st.session_state:
    st.session_state.section_index = 0

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Sidebar NavegaciÃ³n
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

with st.sidebar:
    st.markdown("### ğŸ“‘ NavegaciÃ³n rÃ¡pida")
    labels_with_status = [
        f"{'âœ…' if st.session_state.get(section['key'], False) else 'ğŸ”²'} {section['label']}"
        for section in section_definitions
    ]
    selected_label = st.selectbox("Ir a secciÃ³n", labels_with_status, index=st.session_state.section_index)
    selected_index = next(i for i, s in enumerate(section_definitions) if s["label"] in selected_label)

    if selected_index != st.session_state.section_index:
        st.session_state.section_index = selected_index
        st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Render SecciÃ³n Actual
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

current_section = section_definitions[st.session_state.section_index]
st.subheader(current_section["label"])
current_section["render"]()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Barra de Progreso Visual
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

completed_count, progress_percent = compute_progress(st.session_state, [s["key"] for s in section_definitions])

st.progress(progress_percent, text=f"ğŸ”„ Progreso general: {completed_count} de {len(section_definitions)} secciones completadas")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Botones NavegaciÃ³n
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

col1, col2, _ = st.columns([1, 1, 6])

with col1:
    if st.session_state.section_index > 0:
        if st.button("â¬…ï¸ SecciÃ³n anterior"):
            st.session_state.section_index -= 1
            st.rerun()

with col2:
    if st.session_state.section_index < len(section_definitions) - 1:
        if st.button("â¡ï¸ Siguiente secciÃ³n"):
            st.session_state.section_index += 1
            st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Mensaje Final
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if st.session_state.section_index == len(section_definitions) - 1:
    st.success("ğŸ‰ Ha llegado al final del formulario. Puede revisar cualquier secciÃ³n antes de finalizar.")
    if st.button("â¬…ï¸ Volver al inicio"):
        st.session_state.section_index = 0
        st.rerun()

st.markdown("---")
st.markdown("### ğŸ“¤ Guardar encuesta completa")

if st.button("Guardar encuesta como CSV y Google Sheets"):
    flat_data = flatten_session_state(st.session_state)
    success = append_or_update_row(flat_data)
    ips_name = st.session_state.get("identificacion", {}).get("ips_id", "IPS desconocida")
    if success:
        st.success(f"âœ… Encuesta de `{ips_name}` guardada exitosamente.")
    else:
        st.error("âŒ Error al guardar la encuesta. Por favor intente nuevamente.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Footer Institucional
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

st.markdown("<hr>", unsafe_allow_html=True)
render_footer()
